<!doctype html><html lang=fr dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>R√©seau - VLAN Hopping | bWlrYQ | Blog</title><meta name=keywords content="R√©seau,S√©curit√©,Couche 2,VLAN,Attaque"><meta name=description content="Article √† propos du VLAN Hopping ainsi que les techniques d&rsquo;exploitation et de limitation de cette attaque"><meta name=author content="bWlrYQ"><link rel=canonical href=https://bwlryq.net/fr/vlan_hopping/><link crossorigin=anonymous href=/assets/css/stylesheet.abc7c82c3d415a6df50430738d1cbcc4c76fea558bc5a0c830d3babf78167a35.css integrity="sha256-q8fILD1BWm31BDBzjRy8xMdv6lWLxaDIMNO6v3gWejU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad();></script><link rel=icon href=https://bwlryq.net/img/pfp.png><link rel=icon type=image/png sizes=16x16 href=https://bwlryq.net/img/pfp.png><link rel=icon type=image/png sizes=32x32 href=https://bwlryq.net/img/pfp.png><link rel=apple-touch-icon href=https://bwlryq.net/img/pfp.png><link rel=mask-icon href=https://bwlryq.net/img/pfp.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://bwlryq.net/posts/vlan_hopping/><link rel=alternate hreflang=fr href=https://bwlryq.net/fr/vlan_hopping/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="R√©seau - VLAN Hopping"><meta property="og:description" content="Article √† propos du VLAN Hopping ainsi que les techniques d&rsquo;exploitation et de limitation de cette attaque"><meta property="og:type" content="article"><meta property="og:url" content="https://bwlryq.net/fr/vlan_hopping/"><meta property="og:image" content="https://bwlryq.net/img/pfp.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-22T00:00:00+00:00"><meta property="article:modified_time" content="2022-11-22T00:00:00+00:00"><meta property="og:site_name" content="bWlrYQ | Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bwlryq.net/img/pfp.png"><meta name=twitter:title content="R√©seau - VLAN Hopping"><meta name=twitter:description content="Article √† propos du VLAN Hopping ainsi que les techniques d&rsquo;exploitation et de limitation de cette attaque"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"R√©seau - VLAN Hopping","item":"https://bwlryq.net/fr/vlan_hopping/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"R√©seau - VLAN Hopping","name":"R√©seau - VLAN Hopping","description":"Article √† propos du VLAN Hopping ainsi que les techniques d\u0026rsquo;exploitation et de limitation de cette attaque","keywords":["R√©seau","S√©curit√©","Couche 2","VLAN","Attaque"],"articleBody":"Introduction Durant le CTF Flag‚ÄôMalo #6 organis√© de mani√®re annuelle par mon d√©partement universitaire j‚Äôai pu donner un talk rapide sur le ‚ÄúVLAN Hopping‚Äù (ou saut de VLAN en bon fran√ßais). Cette vuln√©rabilit√© est une vuln√©rabilit√© qui se situe au niveau de la couche 2 et qui peut √™tre utilis√©e pour sniffer des paquets provenants d‚Äôautres VLANs ou encore d‚Äôacc√©der √† des h√¥tes pr√©sents sur d‚Äôautres VLANs que celui sur lequel se trouve l‚Äôattaquant √† l‚Äôorigine.\nLes slides de cette conf√©rence sont disponibles sur mon GitHub ici.\nCe billet est fait √† but √©ducatif uniquement. Pour des raisons l√©gales vous n‚Äô√™tes pas autoris√© √† reproduire aucune des techniques pr√©sentes sur un r√©seau √† moins que vous ayez re√ßu la permission √©crote et explicite du propri√©taire. Quoiqu‚Äôil en soit vous pouvez toujours construire un r√©seau virtuel √† l‚Äôaide de GNS3 ou autre (EVE-NG) et pratiquer dessus.\nVLANs - Rappels  Disclaimer: ces quelques paragraphes ne sont pas un cours sur les VLANs, je recommande fortement de suivre un r√©el cours sur le sujet avant de tenter de r√©aliser un exploit. Cela n‚Äôaurait que tr√®s peu d‚Äôint√©r√™t et vous permettra de mieux appr√©hender cette technologie ainsi que ses usages.\n VLANS - Introduction Pour commencer, pour ceux d‚Äôentre-vous qui ne conna√Ætraient pas les VLANs nous pouvons rapidement regarder ce qu‚Äôils sont et √† quoi ils servent. Pour ceux qui seraient d√©j√† familiers avec le principe, je vous invite √† vous rendre directement √† ce chapitre VLAN Hopping - Techniques.\nDonc, que sont les VLANs ? Par d√©finition (Wikipedia):\n ‚ÄúUn r√©seau local virtuel, commun√©ment appel√© VLAN (pour Virtual LAN), est un r√©seau informatique logique ind√©pendant. De nombreux VLAN peuvent coexister sur un m√™me commutateur r√©seau ou ¬´¬†switch¬†¬ª. \"\n Cette d√©finition est assez courte et peu se montrer obscure pour les ‚Äúnon-initi√©s‚Äù. Essayons d‚Äôinvestiguer un peu plus et imaginons que je suis un administrateur syst√®me qui travaille pour une petite entreprise avec peu de moyens. Pour des raisons de s√©curit√© je ne souhaite pas que les comptables puissent acc√©der √† l‚Äôinfrastructure r√©serv√©es aux RHs et inversement, on peut aussi ajouter une direction et un secr√©tariat par exemple. Je peux les mettres tous dans un LAN diff√©rent par exemple (192.168.1.0/24, 192.168.2.0/24 ‚Ä¶) et ensuite effectuer du routage au niveau de ces diff√©rents r√©seaux mais cela demanderait soit plusieurs routeurs (co√ªteux) ou un routeur avec de multiples ports (co√ªteux aussi). C‚Äôest une solution fonctionnelle mais trop co√ªteuse en termes d‚Äô√©quipement actifs. En utilisant cette solution notre r√©seau aurait la structure suivante (sans les routeurs)\nCe n‚Äôest pas vraiment concevable, les VLANs vont nous permettre de segmenter un r√©seau en diff√©rents r√©seaux isol√©s les uns des autres. Chaque VLAN aura donc un num√©ro associ√© (par exemple VLAN 100, VLAN 200 etc‚Ä¶). Cette technologie de niveau 2 ((Wikipedia)[https://fr.wikipedia.org/wiki/Couche_liaison_de_donn%C3%A9es]) va nous permettre d‚Äôavoir la s√©curit√© initalement pr√©vue par notre premier montage tout en r√©duisant fortement le nombre de switches sur notre r√©seau ainsi que de simplifier la topologie physique de celui-ci. En utilisant des VLANs sur notre r√©seau, le r√©sultat serait le suivant (toujours sans routeur):\nEn d√©finitive, les VLANs ont de multiples avantages, ils:\n R√©duisent les co√ªts de l‚Äôinfrastructure Am√©liorent la topologie physique du r√©seau Renforcent l‚Äôaspect de s√©curit√©  VLANs - Modes Pour l‚Äôinstant, il y a un souci au niveau de ce que j‚Äôai pr√©sent√© des VLANs, on peut ais√©ment deviner que tous les employ√©s ne travaillent pas dans la m√™me pi√®ce, alors comment faire s‚Äôils sont dans deux pi√®ces s√©par√©s et que nous avons deux switches par exemple. Nous n‚Äôallons pas faire un lien pour chaque VLAN entre les switches, √ßa n‚Äôaurait pas de sens et irait √† l‚Äôencontre du concept de simplification de la couche physique.\nOn peut maintenant introduire les modes. Sur les ports d‚Äôun commutateur, il existe deux modes diff√©rents quand on utilise les vlans, le mode acc√®s et le mode trunk. Un port en mode acc√®s ne laissera passer qu‚Äôun seul VLAN sp√©cifi√© au pr√©alable. Un port en mode trunk lui permettra de laisser passer un ou plusieurs VLANs. Cela permet donc entre deux commutateurs de n‚Äôavoir qu‚Äôun seul lien pour tous les VLANs tout en gardant l‚Äôaspect de simplicit√© souhait√©. Le mode acc√®s est celui qui est initialement pr√©vu pour les √©quipements de terminaison (imprimante, ordinateur, serveur, t√©l√©phone‚Ä¶)\nReprenons notre pr√©c√©dent sch√©ma et imaginons que nos employ√©s sont dans deux open space diff√©rents, il nous faut donc deux commutateurs que nous allons relier entre eux √† l‚Äôaide d‚Äôun lien ‚Äútrunk‚Äù:\nMaintenant que nous avons abord√©s les essentiels li√©s aux VLANS (il resterait notamment √† discuter du routage inter-vlan mais il n‚Äôentre pas en compte dans le cadre de cet article qui n‚Äôa pas pour vocation d‚Äô√™tre un cours).\nVLAN Hopping - Techniques Par d√©faut les VLANs sont s√©curis√©s, les vuln√©rabilit√©s li√©es √† ceux-ci sont d√ªs √† des mauvaises configurations de la part des administrateurs de r√©seau (ou bien des constructeurs, Cisc‚Ä¶). Pour ce post, je vais introduire deux m√©thodes diff√©rents qui vous permettraient d‚Äôexploiter des erreurs de configuration sur un r√©seau exploitant des VLANs. M√©thode 1: Double Tagging La premi√®re m√©thode que je souhaite introduire est la plus simple √† mettre en place, il s‚Äôagit du Double Tagging, comme je l‚Äôai dit, chaque VLAN poss√®de un num√©ro assign√©. Afin de transiter entre deux commutateurs, une trame Ethernet se voit tagu√©e avec le num√©ro du VLAN qui lui est associ√© afin que chaque commutateur puisse savoir dans quel VLAN est l‚Äô√©quipement source. Donc chaque trame poss√®de un num√©ro de VLAN, int√©ressant‚Ä¶\nNous savons que les couches en r√©seau sont bas√©es sur le principe d‚Äôencapsulation et de d√©sencapsulation. Quand un switch re√ßoit un paquet provenant d‚Äôun h√¥te alors il va ajouter le tag du VLAN associ√© au port duquel provient la trame, mais le switch auquel est branch√© l‚Äô√©quipement de destination retirera ce tag afin de lui fournir la trame (les √©quipements de terminaison n‚Äôont pas conscience du concept de VLAN). Alors que se passe-t-il si je craft mon propre paquet et que je le tag avec le num√©ro de VLAN que je souhaite ?\nEt bien, ce n‚Äôest pas aussi facile que √ßa, sinon nous aurions un r√©el probl√®me‚Ä¶ Par d√©fault les VLANs sont ‚Äús√©curis√©s‚Äù, en revanche quand on parle de VLANs il existe la notion de VLAN natif sont num√©ro est g√©n√©ralement (par d√©faut) le 1. En r√©sum√©, m√™me sans mettre en place de VLANs, vous √™tes dans le VLAN1 mais √ßa n‚Äôaffecte absolument pas le r√©seau puisque tous les √©quipements sont dans le m√™me. Ce vlan natif n‚Äôest donc pas tagu√©, alors que se passe-t-il si un switch re√ßoit une trame tagu√©e avec le VLAN par d√©faut ? R√©ponse: il va retirer le tag avant de transmettre la trame √† un autre commutateur.\nVous commencez √† voir le probl√®me ? Dans une configuration r√©seau qui fait que nous passons par aux moins deux commutateurs et que nous sommes connect√©s au VLAN par d√©faut alors nous pouvons crafter un paquet malicieux qui contient deux tags √† la suite. Le premier sera le VLAN 1 et le second le VLAN dans lequel on souhaite se rendre.\nLe diagramme suivant illustre la vuln√©rabilit√©: Cette attaque est tr√®s simple √† mettre en place mais elle poss√®de deux grandes failles, on ne peut pas recevoir le traffic d‚Äôun autre VLAN, on peut uniquement acc√©der √† un h√¥te qui se trouve dans un autre VLAN. Elle n√©cessite aussi de se trouver dans une configuration o√π l‚Äôon va traverser au moins deux commutateurs.\nM√©thode 2: Switch Spoofing La seconde m√©thode est beaucoup plus int√©ressante que la premi√®re car celle-ci va nous permettre d‚Äôagir comme si nous √©tions dans le VLAN que nous attaquons, il n‚Äôy a pas de limitations comme sur la pr√©c√©dente. Nous pouvons agir comme si nous √©tions un √©quipement l√©gitime du VLAN. Quoiqu‚Äôil en soit il reste un param√®tre important √† prendre en compte, elle ne fonctionne que sur les √©quipements de la marque Cisco (pas vraiment un probl√®me car tr√®s r√©pandue).\nPour commencer, mettons une petite balle perdue √† Cisco ! Nous pouvons maintenant introduire DTP, le ‚ÄúDynamic Trunking Protocol‚Äù, un protocole propri√©taire d√©stin√© aux syst√®mes Cisco. Ce protocole vise √† √©tablir de mani√®re automatique un lien trunk entre deux switches. Par d√©faut le protocole DTP est actif sur n‚Äôimporte quel switch, il est n√©cessaire de le d√©sactiver si vous souhaitez fixer un port en mode acc√®s.\nIl existe deux modes int√©ressants avec DTP pour un port, dynamic auto ou dynamic desirable. En mode auto le switch √©coute pour une trame DTP lui indiquant que l‚Äôon souhaite √©tablir un lien trunk. En mode desirable alors le switch envoie de mani√®re active et r√©guli√®re des trames DTP montrant qu‚Äôil souhaite monter un lien trunk.\nOn peut regarder la fa√ßon dont un lien trunk est √©tabli entre deux h√¥tes quand on branche un h√¥te √† un qui souhaite monter un lien trunk avec ce diagramme. Une fois que notre lien trunk est √©tabli, on peut int√©ragir avec n‚Äôimporte quelle machine de n‚Äôimporte quel VLAN convoy√© par le trunk.\nSc√©nario d‚Äôattaque simple La th√©orie c‚Äôest cool mais rien ne vaut la pratique ! On peut imaginer un sc√©nario simple avec un tout petit r√©seau d‚Äôentreprise o√π nous sommes dans un VLAN et on veut sauter de celui-ci vers un autre. Voici le sch√©ma (simplifi√©) associ√©: Ici PC1 est dans le VLAN 100 avec l‚Äôadresse IP 192.168.100.1/24 et PC2 poss√®de l‚Äôadresse IP 192.168.100.254/24 dans le VLAN 200. Dans cette configuration les deux √©quipements sont sur le m√™me r√©seau IP mais dans des VLANs s√©par√©s ils sont donc normalement inacessibles si l‚Äôon est pas dans le VLAN correspondant. La configuration du switch est la suivante (des parties inutiles ont √©t√© coup√©es):\nversion 15.0 ! hostname switch_entreprise ! interface GigabitEthernet0/1 description **Machine VLAN 100** switchport access vlan 100 switchport mode access ! interface GigabitEthernet0/2 description **Vlan 100 access, trunk dynamic desirable** switchport trunk encapsulation dot1q switchport trunk native vlan 100 switchport mode dynamic desirable ! ! SAME FOR Gi0/3 - Gi0/6 ! interface GigabitEthernet0/7 description **Vlan 100 access, trunk dynamic desirable** switchport trunk encapsulation dot1q switchport trunk native vlan 100 switchport mode dynamic desirable ! interface GigabitEthernet0/8 description **Machine VLAN 200** switchport access vlan 200 switchport mode access ! interface GigabitEthernet0/9 description **Shut** shutdown ! interface GigabitEthernet0/10 description **Shut** shutdown ! interface Vlan1 ip address 192.168.100.1 255.255.255.0 shutdown ! interface Vlan100 ip address 192.168.100.1 255.255.255.0 ! interface Vlan200 no ip address On reamrque que les ports Gi0/2 √† Gi0/7 sont dans le VLAN 100 mais le protocole DTP n‚Äôest pas d√©sactiv√©, cela signifie que si nous branchons un √©quipement qui n‚Äôest pas un commutateur Cisco alors nous seront par d√©faut dans le VLAN 100 en mode acc√®s. En revanche, si on connecte un commutateur Cisco alors un lien trunk tentera de s‚Äô√©tablir entre les deux, faisant alors transiter tous les VLANs.\nProof Of Concept C‚Äôest l‚Äôheure d‚Äôexploiter ce r√©seau ! Disons que les ports Gi0/2 √† Gi0/7 sont brass√©s vers diff√©rentes salles pour permettre √† n‚Äôimporte qui de se brancher √† Internet sans pouvoir acc√©der aux machines du VLAN 100. Dans le cadre d‚Äôune utilisation non malveillante alors nous n‚Äôauront aucun probl√®me. Dans le cas contraire cette configuration nous r√©serve quelques surprises.\nM√©thode 1 Si nous amenons notre propre switch et le branchons au r√©seau de la mani√®re suivante:\nAlors notre h√¥te est connect√© √† Internet et aura une IP attribu√©e par un DHCP (que l‚Äôon imagine). Commen√ßons par r√©cup√©rer notre IP: Essayons de ping PC1 ainsi que l‚Äôinterface du VLAN 100: Et de ping PC2: Sans grande surprise c‚Äôest un √©chec, nous ne pouvons pas pinger PC2 mais essayons de r√©soudre cela ! Sur notre switch attaquant on peut voir qu‚Äôun lien trunk s‚Äôest √©tabli tout de suite et de mani√®re automatique: Nous avons juste √† basculer dans le VLAN correspondant √† l‚Äôaide des commandes suivantes:\nconf t int Gi0/8 switchport mode access switchport access vlan 200 exit int Gi0/1 switchport trunk native vlan 100 end Et √† envoyer des requ√™tes ICMP √† PC2: e\nC‚Äôest un succ√®s ! Nous avons saut√© d‚Äôun VLAN √† un autre sans toucher √† la configuration du r√©seau dans lequel nous √©tions. M√©thode 2 Disons que je suis vraiment t√™te en l‚Äôair et que j‚Äôai oubli√© mon super commutateur Cisco √† la maison, rien ne m‚Äôarr√™tera ! J‚Äôai juste besoin de forger mes propres paquets DTP, le r√©seau ressemblera alors √† √ßa: On connecte notre machine attaquante et on regarde l‚Äô√©tat du lien trunk sur le switch entreprise (c‚Äôest l‚Äôavantage du PoC, on peut tout regarder): Il n‚Äôy a aucun signe d ‚Äòun lien trunk, mais rappelez-vous en mode desirable un port est en recherche active de l‚Äô√©tablissemenbt d‚Äôun lien trunk. Il envoie des donc des trames DTP √† notre h√¥te (qui les ignore car elles ne lui sont pas destin√©es). En sniffant le traffic, on peut r√©cup√©rer ce paquet DTP et le modifier afin de monter un lien trunk avec le script suivant:\n#Imports from scapy.all import * load_contrib('dtp') #Var trunk_init = False mac_addr = \"00:1b:21:a5:ac:36\" interface = \"eth0\" while not trunk_init: #Listen for DTP frames print(\"[~] Listening for DTP packet...\") pkt = sniff(count=1, iface=interface, filter=\"ether dst 01:00:0c:cc:cc:cc\") print(\"[~] Found DTP packet\") #Craft malicious packet pkt[0].src=mac_addr pkt[0][DTP][DTPStatus].status='\\x03' #Trunk initialization print(\"[!] Intiating trunk...\") try: sendp(pkt[0], loop=0, verbose=1, iface=interface) print(\"[!] Trunk initiated\") trunk_init=True except: print(\"[!] Failed intiating trunk\") Ce script utilise la librairie scapy avec l‚Äôimport de DTP. On peut √©couter le traffic √† la recherche d‚Äôune trame avec pour adresse MAC de destination l‚Äôadresse mutlicast reserv√©e aux protocoles cisco type CDP, DTP etc‚Ä¶ On r√©cup√®re ce paquet, on change l‚Äôadresse srouce par la notre, le statut d‚Äô√©tablissement du lien trunk √† \\x03 (lien en mode desriable) puis renvoyer le paquet. Juste apr√®s notre lien tombe et remonte de mani√®re presque instantan√©e\nLe r√©sultat d‚Äôex√©cution de notre script: On peut maintenant v√©rifier l‚Äô√©tat du trunk: On remarque qu‚Äôun lien trunk a √©t√© √©tabli entre le switch et notre ordinateur qui n‚Äôest donc plsu dans un port en mode acc√®s. On peut donc √©couter le traffic provenant d‚Äôautres VLANs et m√™me crafter nos propres paquets avec un tag sp√©cifique. Dans le but de v√©rifier mon PoC j‚Äôai √©cout√© le traffic jusqu‚Äô√† voir un paquet ARP en provenance de notre PC2 sur le VLAN 200: Cela nous permet de confirmer notre PoC. Pour aller un peu plus loin, j‚Äôai d√©marr√© un serveur web sur ma machine attaquante et je m‚Äôy suis connect√© avec le PC2 (encore les avantages du simple PoC), (et oui j‚Äôavais la flemme de forger mes propres paquets): Mitigations Maintenant que nous avons √©t√© capables d‚Äôexploiter ce VLAN Hopping, comment pouvons-nous √©viter que cela nous arrive sur notre propre r√©seau, et comment au moins rendre la vie plus difficile √† un attaquant ? Il existe quelques patches possibles, ici je donnerai les √©quivalents de commandes pour Cisco mais en quelques recherches on peut trouver pour √† peu pr√®s tous les constructeurs.\nMitigate Double Tagging Le Double Tagging est tr√®s difficile √† √©viter mais on peut drastiquement le limiter de la mani√®re suivante:\n Changer le VLAN natif  switchport trunk native vlan [vlan number]   D√©sactiver les protocoles pouvant donner des informations sur le fonctionnement du r√©seau (CDP par exemple)  no cdp run   Forcer le tagging des VLANs natifs  vlan dot1q tag native    Mitigate Switch Spoofing Vous pouvez limiter le Switch Spoofing comme ceci:\n D√©sactiver DTP sur tous les ports  switchport nonegotiate   Toujours mettre les ports qui ne sont pas des trunks pr√©vus en mode acc√®s  switchport mode access   Utiliser les m√™mes bonnes pratiques que pour le double tagging.  Conclusion Afin de conclure ce billet, je voudrais remercier les lecteurs pour avoir tenu jusqu‚Äôici. Si jamais l‚Äôarticle vous a plu ou appris quoi que ce soit alors n‚Äôh√©sitez pas √† le partager.\nSi jamais vous pensez que certaines pr√©cisions/corrections sont √† apporter n‚Äôh√©sitez pas √† me contacter sur mes r√©seaux sociaux, Twitter ici ou sur Discord \\`#0001.\nMerci √† Flag‚ÄôMalo de m‚Äôavoir donn√© l‚Äôopportunit√© de r√©aliser mon premier talk.\nEt comme je n‚Äôai fait de blague √† propos de Cisco que deux fois, en voici une troisi√®me pour finir l‚Äôarticle en beaut√© ! ","wordCount":"2668","inLanguage":"fr","datePublished":"2022-11-22T00:00:00Z","dateModified":"2022-11-22T00:00:00Z","author":{"@type":"Person","name":"bWlrYQ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bwlryq.net/fr/vlan_hopping/"},"publisher":{"@type":"Organization","name":"bWlrYQ | Blog","logo":{"@type":"ImageObject","url":"https://bwlryq.net/img/pfp.png"}}}</script></head><body class=dark id=top><script>if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}</script><header class=header><nav class=nav><div class=logo><a href=https://bwlryq.net/fr/ accesskey=h title="Accueil (Alt + H)"><img src=https://bwlryq.net/img/pfp.png alt aria-label=logo height=35>Accueil</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://bwlryq.net/ title=üá¨üáß aria-label=üá¨üáß>En</a></li></ul></div></div><ul id=menu><li><a href=https://bwlryq.net/fr/whoami/ title="Qui suis-je ?"><span>Qui suis-je ?</span></a></li><li><a href=https://bwlryq.net/fr/posts/ title=Articles><span>Articles</span></a></li><li><a href=https://bwlryq.net/fr/cheatsheets/ title=Cheatsheets><span>Cheatsheets</span></a></li><li><a href=https://bwlryq.net/fr/search/ title=Recherche><span>Recherche</span></a></li><li><a href=https://bwlryq.net/fr/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://root-me.org/bWlrYQ title="Profil Root-Me"><span>Profil Root-Me</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://bwlryq.net/fr/>Accueil</a></div><h1 class=post-title>R√©seau - VLAN Hopping</h1><div class=post-meta><span title="2022-11-22 00:00:00 +0000 UTC">November 22, 2022</span>&nbsp;¬∑&nbsp;13 min&nbsp;¬∑&nbsp;2668 mots&nbsp;¬∑&nbsp;bWlrYQ&nbsp;|&nbsp;Traductions:<ul class=i18n_list><li><a href=https://bwlryq.net/posts/vlan_hopping/>En</a></li></ul></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table des mati√®res</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#vlans---rappels>VLANs - Rappels</a><ul><li><a href=#vlans---introduction>VLANS - Introduction</a></li><li><a href=#vlans---modes>VLANs - Modes</a></li></ul></li><li><a href=#vlan-hopping---techniques>VLAN Hopping - Techniques</a><ul><li><a href=#m√©thode-1-double-tagging>M√©thode 1: Double Tagging</a></li><li><a href=#m√©thode-2-switch-spoofing>M√©thode 2: Switch Spoofing</a></li></ul></li><li><a href=#sc√©nario-dattaque-simple>Sc√©nario d&rsquo;attaque simple</a></li><li><a href=#proof-of-concept>Proof Of Concept</a><ul><li><a href=#m√©thode-1>M√©thode 1</a></li><li><a href=#m√©thode-2>M√©thode 2</a></li></ul></li><li><a href=#mitigations>Mitigations</a><ul><li><a href=#mitigate-double-tagging>Mitigate Double Tagging</a></li><li><a href=#mitigate-switch-spoofing>Mitigate Switch Spoofing</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details></div><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>Durant le CTF <a href=https://flagmalo.fr/><strong>Flag&rsquo;Malo #6</strong></a> organis√© de mani√®re annuelle par mon d√©partement universitaire j&rsquo;ai pu donner un talk rapide sur le &ldquo;VLAN Hopping&rdquo; (ou saut de VLAN en bon fran√ßais). Cette vuln√©rabilit√© est une vuln√©rabilit√© qui se situe au niveau de la couche 2 et qui peut √™tre utilis√©e pour sniffer des paquets provenants d&rsquo;autres VLANs ou encore d&rsquo;acc√©der √† des h√¥tes pr√©sents sur d&rsquo;autres VLANs que celui sur lequel se trouve l&rsquo;attaquant √† l&rsquo;origine.</p><p>Les slides de cette conf√©rence sont disponibles sur mon GitHub <a href=https://github.com/bWlrYQ/vlan_hopping/>ici</a>.</p><p>Ce billet est fait √† but √©ducatif uniquement. Pour des raisons l√©gales vous n&rsquo;√™tes pas autoris√© √† reproduire aucune des techniques pr√©sentes sur un r√©seau √† moins que vous ayez re√ßu la permission √©crote et explicite du propri√©taire. Quoiqu&rsquo;il en soit vous pouvez toujours construire un r√©seau virtuel √† l&rsquo;aide de <a href=https://www.gns3.com/>GNS3</a> ou autre (EVE-NG) et pratiquer dessus.</p><h2 id=vlans---rappels>VLANs - Rappels<a hidden class=anchor aria-hidden=true href=#vlans---rappels>#</a></h2><blockquote><p>Disclaimer: ces quelques paragraphes <strong>ne sont pas</strong> un cours sur les VLANs, je recommande fortement de suivre un r√©el cours sur le sujet avant de tenter de r√©aliser un exploit. Cela n&rsquo;aurait que tr√®s peu d&rsquo;int√©r√™t et vous permettra de mieux appr√©hender cette technologie ainsi que ses usages.</p></blockquote><h3 id=vlans---introduction>VLANS - Introduction<a hidden class=anchor aria-hidden=true href=#vlans---introduction>#</a></h3><p>Pour commencer, pour ceux d&rsquo;entre-vous qui ne conna√Ætraient pas les VLANs nous pouvons rapidement regarder ce qu&rsquo;ils sont et √† quoi ils servent. Pour ceux qui seraient d√©j√† familiers avec le principe, je vous invite √† vous rendre directement √† ce chapitre <a href=#vlan-hopping---techniques>VLAN Hopping - Techniques</a>.</p><p>Donc, que sont les VLANs ? Par d√©finition (<a href=https://fr.wikipedia.org/wiki/VLAN>Wikipedia</a>):</p><blockquote><p>&ldquo;Un r√©seau local virtuel, commun√©ment appel√© VLAN (pour Virtual LAN), est un r√©seau informatique logique ind√©pendant. De nombreux VLAN peuvent coexister sur un m√™me commutateur r√©seau ou ¬´¬†switch¬†¬ª. "</p></blockquote><p>Cette d√©finition est assez courte et peu se montrer obscure pour les &ldquo;non-initi√©s&rdquo;. Essayons d&rsquo;investiguer un peu plus et imaginons que je suis un administrateur syst√®me qui travaille pour une petite entreprise avec peu de moyens. Pour des raisons de s√©curit√© je ne souhaite pas que les comptables puissent acc√©der √† l&rsquo;infrastructure r√©serv√©es aux RHs et inversement, on peut aussi ajouter une direction et un secr√©tariat par exemple. Je peux les mettres tous dans un LAN diff√©rent par exemple (192.168.1.0/24, 192.168.2.0/24 &mldr;) et ensuite effectuer du routage au niveau de ces diff√©rents r√©seaux mais cela demanderait soit plusieurs routeurs (co√ªteux) ou un routeur avec de multiples ports (co√ªteux aussi). C&rsquo;est une solution fonctionnelle mais trop co√ªteuse en termes d&rsquo;√©quipement actifs. En utilisant cette solution notre r√©seau aurait la structure suivante (sans les routeurs)</p><p><img loading=lazy src=/img/posts/vlan_hopping/schema_reseau_sans_vlan.svg alt=network_without_vlan></p><p>Ce n&rsquo;est pas vraiment concevable, les VLANs vont nous permettre de segmenter un r√©seau en diff√©rents r√©seaux isol√©s les uns des autres. Chaque VLAN aura donc un num√©ro associ√© (par exemple VLAN 100, VLAN 200 etc&mldr;). Cette technologie de niveau 2 ((Wikipedia)[https://fr.wikipedia.org/wiki/Couche_liaison_de_donn%C3%A9es]) va nous permettre d&rsquo;avoir la s√©curit√© initalement pr√©vue par notre premier montage tout en r√©duisant fortement le nombre de switches sur notre r√©seau ainsi que de simplifier la topologie physique de celui-ci. En utilisant des VLANs sur notre r√©seau, le r√©sultat serait le suivant (toujours sans routeur):</p><p><img loading=lazy src=/img/posts/vlan_hopping/reseau_avec_vlan.svg alt=network_with_vlans></p><p>En d√©finitive, les VLANs ont de multiples avantages, ils:</p><ul><li>R√©duisent les co√ªts de l&rsquo;infrastructure</li><li>Am√©liorent la topologie physique du r√©seau</li><li>Renforcent l&rsquo;aspect de s√©curit√©</li></ul><h3 id=vlans---modes>VLANs - Modes<a hidden class=anchor aria-hidden=true href=#vlans---modes>#</a></h3><p>Pour l&rsquo;instant, il y a un souci au niveau de ce que j&rsquo;ai pr√©sent√© des VLANs, on peut ais√©ment deviner que tous les employ√©s ne travaillent pas dans la m√™me pi√®ce, alors comment faire s&rsquo;ils sont dans deux pi√®ces s√©par√©s et que nous avons deux switches par exemple. Nous n&rsquo;allons pas faire un lien pour chaque VLAN entre les switches, √ßa n&rsquo;aurait pas de sens et irait √† l&rsquo;encontre du concept de simplification de la couche physique.</p><p>On peut maintenant introduire les <strong>modes</strong>. Sur les ports d&rsquo;un commutateur, il existe deux modes diff√©rents quand on utilise les vlans, le <strong>mode acc√®s</strong> et le <strong>mode trunk</strong>. Un port en mode acc√®s ne laissera passer qu&rsquo;un seul VLAN sp√©cifi√© au pr√©alable. Un port en mode trunk lui permettra de laisser passer un ou plusieurs VLANs. Cela permet donc entre deux commutateurs de n&rsquo;avoir qu&rsquo;un seul lien pour tous les VLANs tout en gardant l&rsquo;aspect de simplicit√© souhait√©. Le mode acc√®s est celui qui est initialement pr√©vu pour les √©quipements de terminaison (imprimante, ordinateur, serveur, t√©l√©phone&mldr;)</p><p>Reprenons notre pr√©c√©dent sch√©ma et imaginons que nos employ√©s sont dans deux open space diff√©rents, il nous faut donc deux commutateurs que nous allons relier entre eux √† l&rsquo;aide d&rsquo;un lien &ldquo;trunk&rdquo;:<br><img loading=lazy src=/img/posts/vlan_hopping/schema_vlan_avec_trunk.svg alt=network_with_vlan_and_trunk></p><p>Maintenant que nous avons abord√©s les essentiels li√©s aux VLANS (il resterait notamment √† discuter du routage inter-vlan mais il n&rsquo;entre pas en compte dans le cadre de cet article qui n&rsquo;a pas pour vocation d&rsquo;√™tre un cours).</p><h2 id=vlan-hopping---techniques>VLAN Hopping - Techniques<a hidden class=anchor aria-hidden=true href=#vlan-hopping---techniques>#</a></h2><p>Par d√©faut les VLANs sont s√©curis√©s, les vuln√©rabilit√©s li√©es √† ceux-ci sont d√ªs √† des mauvaises configurations de la part des administrateurs de r√©seau (ou bien des constructeurs, <del>Cisc</del>&mldr;). Pour ce post, je vais introduire deux m√©thodes diff√©rents qui vous permettraient d&rsquo;exploiter des erreurs de configuration sur un r√©seau exploitant des VLANs.
<img loading=lazy src=/img/posts/vlan_hopping/bugs_bunny.jpg alt=meme_vlans_sysadmin></p><h3 id=m√©thode-1-double-tagging>M√©thode 1: Double Tagging<a hidden class=anchor aria-hidden=true href=#m√©thode-1-double-tagging>#</a></h3><p>La premi√®re m√©thode que je souhaite introduire est la plus simple √† mettre en place, il s&rsquo;agit du <strong>Double Tagging</strong>, comme je l&rsquo;ai dit, chaque VLAN poss√®de un num√©ro assign√©. Afin de transiter entre deux commutateurs, une trame Ethernet se voit tagu√©e avec le num√©ro du VLAN qui lui est associ√© afin que chaque commutateur puisse savoir dans quel VLAN est l&rsquo;√©quipement source. Donc chaque trame poss√®de un num√©ro de VLAN, int√©ressant&mldr;</p><p>Nous savons que les couches en r√©seau sont bas√©es sur le principe d&rsquo;encapsulation et de d√©sencapsulation. Quand un switch re√ßoit un paquet provenant d&rsquo;un h√¥te alors il va ajouter le tag du VLAN associ√© au port duquel provient la trame, mais le switch auquel est branch√© l&rsquo;√©quipement de destination retirera ce tag afin de lui fournir la trame (les √©quipements de terminaison n&rsquo;ont pas conscience du concept de VLAN). Alors que se passe-t-il si je craft mon propre paquet et que je le tag avec le num√©ro de VLAN que je souhaite ?</p><p>Et bien, ce n&rsquo;est pas aussi facile que √ßa, sinon nous aurions un r√©el probl√®me&mldr; Par d√©fault les VLANs sont &ldquo;s√©curis√©s&rdquo;, en revanche quand on parle de VLANs il existe la notion de VLAN natif sont num√©ro est g√©n√©ralement (par d√©faut) le 1. En r√©sum√©, m√™me sans mettre en place de VLANs, vous √™tes dans le VLAN1 mais √ßa n&rsquo;affecte absolument pas le r√©seau puisque tous les √©quipements sont dans le m√™me. Ce vlan natif n&rsquo;est donc pas tagu√©, alors que se passe-t-il si un switch re√ßoit une trame tagu√©e avec le VLAN par d√©faut ? R√©ponse: il va retirer le tag avant de transmettre la trame √† un autre commutateur.</p><p>Vous commencez √† voir le probl√®me ? Dans une configuration r√©seau qui fait que nous passons par aux moins deux commutateurs et que nous sommes connect√©s au VLAN par d√©faut alors nous pouvons crafter un paquet malicieux qui contient deux tags √† la suite. Le premier sera le VLAN 1 et le second le VLAN dans lequel on souhaite se rendre.</p><p>Le diagramme suivant illustre la vuln√©rabilit√©:
<img loading=lazy src=/img/posts/vlan_hopping/schema_double_tagging.svg alt=double_tagging_schema></p><p>Cette attaque est tr√®s simple √† mettre en place mais elle poss√®de deux grandes failles, on ne peut pas recevoir le traffic d&rsquo;un autre VLAN, on peut uniquement acc√©der √† un h√¥te qui se trouve dans un autre VLAN. Elle n√©cessite aussi de se trouver dans une configuration o√π l&rsquo;on va traverser au moins deux commutateurs.</p><h3 id=m√©thode-2-switch-spoofing>M√©thode 2: Switch Spoofing<a hidden class=anchor aria-hidden=true href=#m√©thode-2-switch-spoofing>#</a></h3><p>La seconde m√©thode est beaucoup plus int√©ressante que la premi√®re car celle-ci va nous permettre d&rsquo;agir comme si nous √©tions dans le VLAN que nous attaquons, il n&rsquo;y a pas de limitations comme sur la pr√©c√©dente. Nous pouvons agir comme si nous √©tions un √©quipement l√©gitime du VLAN. Quoiqu&rsquo;il en soit il reste un param√®tre important √† prendre en compte, elle ne fonctionne que sur les √©quipements de la marque Cisco (pas vraiment un probl√®me car tr√®s r√©pandue).</p><p>Pour commencer, mettons une petite balle perdue √† Cisco !
<img loading=lazy src=/img/posts/vlan_hopping/gru.jpg alt=double_tagging_schema></p><p>Nous pouvons maintenant introduire DTP, le &ldquo;Dynamic Trunking Protocol&rdquo;, un protocole propri√©taire d√©stin√© aux syst√®mes Cisco. Ce protocole vise √† √©tablir de mani√®re automatique un lien trunk entre deux switches. Par d√©faut le protocole DTP est actif sur n&rsquo;importe quel switch, il est n√©cessaire de le d√©sactiver si vous souhaitez fixer un port en mode acc√®s.</p><p>Il existe deux modes int√©ressants avec DTP pour un port, <strong>dynamic auto</strong> ou <strong>dynamic desirable</strong>. En mode auto le switch √©coute pour une trame DTP lui indiquant que l&rsquo;on souhaite √©tablir un lien trunk. En mode desirable alors le switch envoie de mani√®re active et r√©guli√®re des trames DTP montrant qu&rsquo;il souhaite monter un lien trunk.</p><p>On peut regarder la fa√ßon dont un lien trunk est √©tabli entre deux h√¥tes quand on branche un h√¥te √† un qui souhaite monter un lien trunk avec ce diagramme.
<img loading=lazy src=/img/posts/vlan_hopping/dtp_vlan_hopping.svg alt=schema_dtp_trunk></p><p>Une fois que notre lien trunk est √©tabli, on peut int√©ragir avec n&rsquo;importe quelle machine de n&rsquo;importe quel VLAN convoy√© par le trunk.</p><h2 id=sc√©nario-dattaque-simple>Sc√©nario d&rsquo;attaque simple<a hidden class=anchor aria-hidden=true href=#sc√©nario-dattaque-simple>#</a></h2><p>La th√©orie c&rsquo;est cool mais rien ne vaut la pratique ! On peut imaginer un sc√©nario simple avec un tout petit r√©seau d&rsquo;entreprise o√π nous sommes dans un VLAN et on veut sauter de celui-ci vers un autre. Voici le sch√©ma (simplifi√©) associ√©:
<img loading=lazy src=/img/posts/vlan_hopping/schema_scenario_entreprise.svg alt=schema_company></p><p>Ici PC1 est dans le <strong>VLAN 100</strong> avec l&rsquo;adresse IP <strong>192.168.100.1/24</strong> et PC2 poss√®de l&rsquo;adresse IP <strong>192.168.100.254/24</strong> dans le <strong>VLAN 200</strong>. Dans cette configuration les deux √©quipements sont sur le m√™me r√©seau IP mais dans des VLANs s√©par√©s ils sont donc normalement inacessibles si l&rsquo;on est pas dans le VLAN correspondant. La configuration du switch est la suivante (des parties inutiles ont √©t√© coup√©es):</p><pre><code>version 15.0
!
hostname switch_entreprise
!
interface GigabitEthernet0/1
 description **Machine VLAN 100**
 switchport access vlan 100
 switchport mode access
!
interface GigabitEthernet0/2
 description **Vlan 100 access, trunk dynamic desirable**
 switchport trunk encapsulation dot1q
 switchport trunk native vlan 100
 switchport mode dynamic desirable
!
! SAME FOR Gi0/3 - Gi0/6
!
interface GigabitEthernet0/7
 description **Vlan 100 access, trunk dynamic desirable**
 switchport trunk encapsulation dot1q
 switchport trunk native vlan 100
 switchport mode dynamic desirable
!
interface GigabitEthernet0/8
 description **Machine VLAN 200**
 switchport access vlan 200
 switchport mode access
!
interface GigabitEthernet0/9
 description **Shut**
 shutdown
!
interface GigabitEthernet0/10
 description **Shut**
 shutdown
!
interface Vlan1
 ip address 192.168.100.1 255.255.255.0
 shutdown
!
interface Vlan100
 ip address 192.168.100.1 255.255.255.0
!
interface Vlan200
 no ip address
</code></pre><p>On reamrque que les ports Gi0/2 √† Gi0/7 sont dans le VLAN 100 mais le protocole DTP n&rsquo;est pas d√©sactiv√©, cela signifie que si nous branchons un √©quipement qui n&rsquo;est pas un commutateur Cisco alors nous seront par d√©faut dans le VLAN 100 en mode acc√®s. En revanche, si on connecte un commutateur Cisco alors un lien trunk tentera de s&rsquo;√©tablir entre les deux, faisant alors transiter tous les VLANs.</p><h2 id=proof-of-concept>Proof Of Concept<a hidden class=anchor aria-hidden=true href=#proof-of-concept>#</a></h2><p>C&rsquo;est l&rsquo;heure d&rsquo;exploiter ce r√©seau ! Disons que les ports Gi0/2 √† Gi0/7 sont brass√©s vers diff√©rentes salles pour permettre √† n&rsquo;importe qui de se brancher √† Internet sans pouvoir acc√©der aux machines du VLAN 100. Dans le cadre d&rsquo;une utilisation non malveillante alors nous n&rsquo;auront aucun probl√®me. Dans le cas contraire cette configuration nous r√©serve quelques surprises.</p><h3 id=m√©thode-1>M√©thode 1<a hidden class=anchor aria-hidden=true href=#m√©thode-1>#</a></h3><p>Si nous amenons notre propre switch et le branchons au r√©seau de la mani√®re suivante:<br><img loading=lazy src=/img/posts/vlan_hopping/schema_attaque_avec_switch.svg alt=schema_company_with_attacker_switch></p><p>Alors notre h√¥te est connect√© √† Internet et aura une IP attribu√©e par un DHCP (que l&rsquo;on imagine). Commen√ßons par r√©cup√©rer notre IP:
<img loading=lazy src=/img/posts/vlan_hopping/get_ip.png alt=get_ip_attacker_host></p><p>Essayons de ping PC1 ainsi que l&rsquo;interface du VLAN 100:
<img loading=lazy src=/img/posts/vlan_hopping/ping_vlan100.png alt=ping_vlan100></p><p>Et de ping PC2:
<img loading=lazy src=/img/posts/vlan_hopping/ping_pc2.png alt=ping_pc2></p><p>Sans grande surprise c&rsquo;est un √©chec, nous ne pouvons pas pinger PC2 mais essayons de r√©soudre cela ! Sur notre switch attaquant on peut voir qu&rsquo;un lien trunk s&rsquo;est √©tabli tout de suite et de mani√®re automatique:
<img loading=lazy src=/img/posts/vlan_hopping/trunk_state_switch_attacker.png alt=trunk_state_switch_attacker></p><p>Nous avons juste √† basculer dans le VLAN correspondant √† l&rsquo;aide des commandes suivantes:</p><pre><code>conf t
int Gi0/8
switchport mode access
switchport access vlan 200
exit
int Gi0/1
switchport trunk native vlan 100
end
</code></pre><p>Et √† envoyer des requ√™tes ICMP √† PC2:
<img loading=lazy src=/img/posts/vlan_hopping/ping_pc2_success.png alt=ping_pc2_success>
e</p><p>C&rsquo;est un succ√®s ! Nous avons saut√© d&rsquo;un VLAN √† un autre sans toucher √† la configuration du r√©seau dans lequel nous √©tions.
<img loading=lazy src=/img/posts/vlan_hopping/spongebob.jpg alt=spongebob></p><h3 id=m√©thode-2>M√©thode 2<a hidden class=anchor aria-hidden=true href=#m√©thode-2>#</a></h3><p>Disons que je suis vraiment t√™te en l&rsquo;air et que j&rsquo;ai oubli√© mon super commutateur Cisco √† la maison, rien ne m&rsquo;arr√™tera ! J&rsquo;ai juste besoin de forger mes propres paquets DTP, le r√©seau ressemblera alors √† √ßa:
<img loading=lazy src=/img/posts/vlan_hopping/schema_company_with_attacker_switch.svg alt=schema_company_with_attacker_switch></p><p>On connecte notre machine attaquante et on regarde l&rsquo;√©tat du lien trunk sur le switch entreprise (c&rsquo;est l&rsquo;avantage du PoC, on peut tout regarder):
<img loading=lazy src=/img/posts/vlan_hopping/trunk_company_switch.png alt=trunk_state_company></p><p>Il n&rsquo;y a aucun signe d &lsquo;un lien trunk, mais rappelez-vous en mode desirable un port est en recherche active de l&rsquo;√©tablissemenbt d&rsquo;un lien trunk. Il envoie des donc des trames DTP √† notre h√¥te (qui les ignore car elles ne lui sont pas destin√©es). En sniffant le traffic, on peut r√©cup√©rer ce paquet DTP et le modifier afin de monter un lien trunk avec le script suivant:</p><div class=highlight><pre class=chroma><code class=language-py data-lang=py><span class=c1>#Imports</span>
<span class=kn>from</span> <span class=nn>scapy.all</span> <span class=kn>import</span> <span class=o>*</span>
<span class=n>load_contrib</span><span class=p>(</span><span class=s1>&#39;dtp&#39;</span><span class=p>)</span>

<span class=c1>#Var</span>
<span class=n>trunk_init</span> <span class=o>=</span> <span class=bp>False</span>
<span class=n>mac_addr</span> <span class=o>=</span> <span class=s2>&#34;00:1b:21:a5:ac:36&#34;</span>
<span class=n>interface</span> <span class=o>=</span> <span class=s2>&#34;eth0&#34;</span>

<span class=k>while</span> <span class=ow>not</span> <span class=n>trunk_init</span><span class=p>:</span>
    <span class=c1>#Listen for DTP frames</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&#34;[~] Listening for DTP packet...&#34;</span><span class=p>)</span>
    <span class=n>pkt</span> <span class=o>=</span> <span class=n>sniff</span><span class=p>(</span><span class=n>count</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>iface</span><span class=o>=</span><span class=n>interface</span><span class=p>,</span> <span class=nb>filter</span><span class=o>=</span><span class=s2>&#34;ether dst 01:00:0c:cc:cc:cc&#34;</span><span class=p>)</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&#34;[~] Found DTP packet&#34;</span><span class=p>)</span>

    <span class=c1>#Craft malicious packet</span>
    <span class=n>pkt</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>src</span><span class=o>=</span><span class=n>mac_addr</span>
    <span class=n>pkt</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=n>DTP</span><span class=p>][</span><span class=n>DTPStatus</span><span class=p>]</span><span class=o>.</span><span class=n>status</span><span class=o>=</span><span class=s1>&#39;</span><span class=se>\x03</span><span class=s1>&#39;</span>

    <span class=c1>#Trunk initialization</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&#34;[!] Intiating trunk...&#34;</span><span class=p>)</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>sendp</span><span class=p>(</span><span class=n>pkt</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>loop</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>verbose</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>iface</span><span class=o>=</span><span class=n>interface</span><span class=p>)</span>
        <span class=k>print</span><span class=p>(</span><span class=s2>&#34;[!] Trunk initiated&#34;</span><span class=p>)</span>
        <span class=n>trunk_init</span><span class=o>=</span><span class=bp>True</span>
    <span class=k>except</span><span class=p>:</span>
        <span class=k>print</span><span class=p>(</span><span class=s2>&#34;[!] Failed intiating trunk&#34;</span><span class=p>)</span>

</code></pre></div><p>Ce script utilise la librairie scapy avec l&rsquo;import de DTP. On peut √©couter le traffic √† la recherche d&rsquo;une trame avec pour adresse MAC de destination l&rsquo;adresse mutlicast reserv√©e aux protocoles cisco type CDP, DTP etc&mldr; On r√©cup√®re ce paquet, on change l&rsquo;adresse srouce par la notre, le statut d&rsquo;√©tablissement du lien trunk √† \x03 (lien en mode desriable) puis renvoyer le paquet. Juste apr√®s notre lien tombe et remonte de mani√®re presque instantan√©e</p><p>Le r√©sultat d&rsquo;ex√©cution de notre script:
<img loading=lazy src=/img/posts/vlan_hopping/result_script_trunk.png alt=result_script_trunk></p><p>On peut maintenant v√©rifier l&rsquo;√©tat du trunk:
<img loading=lazy src=/img/posts/vlan_hopping/trunk_state_company_2.png alt=trunk_state_company_2></p><p>On remarque qu&rsquo;un lien trunk a √©t√© √©tabli entre le switch et notre ordinateur qui n&rsquo;est donc plsu dans un port en mode acc√®s. On peut donc √©couter le traffic provenant d&rsquo;autres VLANs et m√™me crafter nos propres paquets avec un tag sp√©cifique. Dans le but de v√©rifier mon PoC j&rsquo;ai √©cout√© le traffic jusqu&rsquo;√† voir un paquet ARP en provenance de notre PC2 sur le VLAN 200:
<img loading=lazy src=/img/posts/vlan_hopping/arp_pc2.png alt=arp_pc2></p><p>Cela nous permet de confirmer notre PoC. Pour aller un peu plus loin, j&rsquo;ai d√©marr√© un serveur web sur ma machine attaquante et je m&rsquo;y suis connect√© avec le PC2 (encore les avantages du simple PoC), (et oui j&rsquo;avais la flemme de forger mes propres paquets):
<img loading=lazy src=/img/posts/vlan_hopping/laptop_trunk_webserver.png alt=laptop_trunk></p><h2 id=mitigations>Mitigations<a hidden class=anchor aria-hidden=true href=#mitigations>#</a></h2><p>Maintenant que nous avons √©t√© capables d&rsquo;exploiter ce VLAN Hopping, comment pouvons-nous √©viter que cela nous arrive sur notre propre r√©seau, et comment au moins rendre la vie plus difficile √† un attaquant ? Il existe quelques patches possibles, ici je donnerai les √©quivalents de commandes pour Cisco mais en quelques recherches on peut trouver pour √† peu pr√®s tous les constructeurs.</p><h3 id=mitigate-double-tagging>Mitigate Double Tagging<a hidden class=anchor aria-hidden=true href=#mitigate-double-tagging>#</a></h3><p>Le Double Tagging est tr√®s difficile √† √©viter mais on peut drastiquement le limiter de la mani√®re suivante:</p><ul><li>Changer le VLAN natif<ul><li><code>switchport trunk native vlan [vlan number]</code></li></ul></li><li>D√©sactiver les protocoles pouvant donner des informations sur le fonctionnement du r√©seau (CDP par exemple)<ul><li><code>no cdp run</code></li></ul></li><li>Forcer le tagging des VLANs natifs<ul><li><code>vlan dot1q tag native</code></li></ul></li></ul><h3 id=mitigate-switch-spoofing>Mitigate Switch Spoofing<a hidden class=anchor aria-hidden=true href=#mitigate-switch-spoofing>#</a></h3><p>Vous pouvez limiter le Switch Spoofing comme ceci:</p><ul><li>D√©sactiver DTP sur tous les ports<ul><li><code>switchport nonegotiate</code></li></ul></li><li>Toujours mettre les ports qui ne sont pas des trunks pr√©vus en mode acc√®s<ul><li><code>switchport mode access</code></li></ul></li><li>Utiliser les m√™mes bonnes pratiques que pour le double tagging.</li></ul><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Afin de conclure ce billet, je voudrais remercier les lecteurs pour avoir tenu jusqu&rsquo;ici. Si jamais l&rsquo;article vous a plu ou appris quoi que ce soit alors n&rsquo;h√©sitez pas √† le partager.</p><p>Si jamais vous pensez que certaines pr√©cisions/corrections sont √† apporter n&rsquo;h√©sitez pas √† me contacter sur mes r√©seaux sociaux, Twitter <a href=https://twitter.com/bWlrYQ>ici</a> ou sur Discord <code>\`#0001</code>.</p><p>Merci √† Flag&rsquo;Malo de m&rsquo;avoir donn√© l&rsquo;opportunit√© de r√©aliser mon premier talk.</p><p>Et comme je n&rsquo;ai fait de blague √† propos de Cisco que deux fois, en voici une troisi√®me pour finir l&rsquo;article en beaut√© !
<img loading=lazy src=/img/posts/vlan_hopping/man_sweating_meme.jpg alt=man_sweating_meme></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://bwlryq.net/fr/tags/r%C3%A9seau/>R√©seau</a></li><li><a href=https://bwlryq.net/fr/tags/s%C3%A9curit%C3%A9/>S√©curit√©</a></li><li><a href=https://bwlryq.net/fr/tags/couche-2/>Couche 2</a></li><li><a href=https://bwlryq.net/fr/tags/vlan/>VLAN</a></li><li><a href=https://bwlryq.net/fr/tags/attaque/>Attaque</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share R√©seau - VLAN Hopping on twitter" href="https://twitter.com/intent/tweet/?text=R%c3%a9seau%20-%20VLAN%20Hopping&url=https%3a%2f%2fbwlryq.net%2ffr%2fvlan_hopping%2f&hashtags=R%c3%a9seau%2cS%c3%a9curit%c3%a9%2cCouche2%2cVLAN%2cAttaque"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512h-386.892c-34.524.0-62.554-28.03-62.554-62.554v-386.892c0-34.524 28.029-62.554 62.554-62.554h386.892zm-253.927 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share R√©seau - VLAN Hopping on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fbwlryq.net%2ffr%2fvlan_hopping%2f&title=R%c3%a9seau%20-%20VLAN%20Hopping&summary=R%c3%a9seau%20-%20VLAN%20Hopping&source=https%3a%2f%2fbwlryq.net%2ffr%2fvlan_hopping%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512h-386.892c-34.524.0-62.554-28.03-62.554-62.554v-386.892c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0v-129.439c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02v-126.056c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768h75.024zm-307.552-334.556c-25.674.0-42.448 16.879-42.448 39.002.0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share R√©seau - VLAN Hopping on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fbwlryq.net%2ffr%2fvlan_hopping%2f&title=R%c3%a9seau%20-%20VLAN%20Hopping"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512h-386.892c-34.524.0-62.554-28.03-62.554-62.554v-386.892c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zm-119.474 108.193c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zm-160.386-29.702c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share R√©seau - VLAN Hopping on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fbwlryq.net%2ffr%2fvlan_hopping%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978v-192.915h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554v-386.892c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share R√©seau - VLAN Hopping on whatsapp" href="https://api.whatsapp.com/send?text=R%c3%a9seau%20-%20VLAN%20Hopping%20-%20https%3a%2f%2fbwlryq.net%2ffr%2fvlan_hopping%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512h-386.892c-34.524.0-62.554-28.03-62.554-62.554v-386.892c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23-13.314-11.876-22.304-26.542-24.916-31.026s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share R√©seau - VLAN Hopping on telegram" href="https://telegram.me/share/url?text=R%c3%a9seau%20-%20VLAN%20Hopping&url=https%3a%2f%2fbwlryq.net%2ffr%2fvlan_hopping%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47A3.38 3.38.0 0126.49 29.86zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://bwlryq.net/fr/>bWlrYQ | Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu')
if(menu){menu.scrollLeft=localStorage.getItem("menu-scroll-position");menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft);}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script><script>document.querySelectorAll('pre > code').forEach((codeblock)=>{const container=codeblock.parentNode.parentNode;const copybutton=document.createElement('button');copybutton.classList.add('copy-code');copybutton.innerHTML='Copier';function copyingDone(){copybutton.innerHTML='Copi√© !';setTimeout(()=>{copybutton.innerHTML='Copier';},2000);}
copybutton.addEventListener('click',(cb)=>{if('clipboard'in navigator){navigator.clipboard.writeText(codeblock.textContent);copyingDone();return;}
const range=document.createRange();range.selectNodeContents(codeblock);const selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);try{document.execCommand('copy');copyingDone();}catch(e){};selection.removeRange(range);});if(container.classList.contains("highlight")){container.appendChild(copybutton);}else if(container.parentNode.firstChild==container){}else if(codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"){codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);}else{codeblock.parentNode.appendChild(copybutton);}});</script></body></html>